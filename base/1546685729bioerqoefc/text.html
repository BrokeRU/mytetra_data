<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p align="center" style=" margin-top:0px; margin-bottom:32px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#e3e3e3;"><a href="https://arjunsreedharan.org/post/99370248137/kernels-201-lets-write-a-kernel-with-keyboard"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; text-decoration: underline; color:#222222;">Kernels 201 -<br />Let’s write a Kernel with keyboard and screen support</span></a></p>
<p align="center" style=" margin-top:17px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://arjunsreedharan.org/"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:792; text-decoration: underline; color:#222222; background-color:#e3e3e3;">Arjun Sreedharan</span></a></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">In my previous article</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><a href="https://arjunsreedharan.org/post/82710718100/kernels-101-lets-write-a-kernel"><span style=" font-family:'arial,sans-serif'; font-size:9pt; text-decoration: underline; color:#0f6692;">Kernels 101 - Let’s write a Kernel</span></a><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">, <br />I wrote how we can build a rudimentary x86 kernel that boots up using GRUB, <br />runs in protected mode and prints a string on the screen.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Today, we will extend that kernel to include keyboard driver that can read the characters a-z and 0-9 from the keyboard and print them on screen.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Source code used for this article is available at my</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><a href="https://github.com/arjun024/mkeykernel"><span style=" font-family:'arial,sans-serif'; font-size:9pt; text-decoration: underline; color:#0f6692;">Github repository - mkeykernel</span></a></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><img src="image1546685891yqnk1iqrip.png" /></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">We communicate with I/O devices using</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">I/O ports</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. These ports are just specific address on the x86’s I/O bus, nothing more. The read/write operations from these ports are accomplished using specific instructions built into the processor.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; font-family:'Sans Serif'; font-size:9pt; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Reading from and Writing to ports</span></p>
<p style=" margin-top:17px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">read_port:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	mov edx, [esp + </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">4</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">in</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> al, dx	</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	ret</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">write_port:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	mov   edx, [esp + </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">4</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">]    </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	mov   al, [esp + </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">4</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> + </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">4</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">]  </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">out</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">   dx, al  </span></p>
<p style=" margin-top:0px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	ret</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">I/O ports are accessed using the</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">in</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> and </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">out</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> instructions that are part of the x86 instruction set.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">In</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">read_port</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">, the port number is taken as argument. When compiler calls your function, it pushes all its arguments onto the stack. The argument is copied to the register </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">edx</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> using the stack pointer. The register </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">dx</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> is the lower 16 bits of </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">edx</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. The </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">in</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> instruction here reads the port whose number is given by </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">dx</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> and puts the result in </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">al</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. Register </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">al</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> is the lower 8 bits of </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">eax</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. If you remember your college lessons, function return values are received through the </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">eax</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> register. Thus </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">read_port</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> lets us read I/O ports.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">write_port</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> is very similar. Here we take 2 arguments: port number and the data to be written. The </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">out</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> instruction writes the data to the port.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; font-family:'Sans Serif'; font-size:9pt; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Interrupts</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Now, before we go ahead with writing any device driver; we need to understand how the processor gets to know that the device has performed an event.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">The easiest solution is</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">polling</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> - to keep checking the status of the device forever. This, for obvious reasons is not efficient and practical. This is where </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">interrupts</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> come into the picture. An interrupt is a signal sent to the processor by the hardware or software indicating an event. With interrupts, we can avoid polling and act only when the specific interrupt we are interested in is triggered.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">A device or a chip called</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Programmable Interrupt Controller (PIC)</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> is responsible for x86 being an interrupt driven architecture. It manages hardware interrupts and sends them to the appropriate system interrupt.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">When certain actions are performed on a hardware device, it sends a pulse called</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Interrupt Request (IRQ)</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> along its specific interrupt line to the PIC chip. The PIC then translates the received IRQ into a system interrupt, and sends a message to interrupt the CPU from whatever it is doing. It is then the kernel’s job to handle these interrupts.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Without a PIC, we would have to poll all the devices in the system to see if an event has occurred in any of them.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Let’s take the case of a keyboard. The keyboard works through the I/O ports</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x60</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> and </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x64</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. Port </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x60</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> gives the data (pressed key) and port </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x64</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> gives the status. However, you have to know exactly when to read these ports.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Interrupts come quite handy here. When a key is pressed, the keyboard gives a signal to the PIC along its interrupt line IRQ1. The PIC has an</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">offset</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> value stored during initialization of the PIC. It adds the input line number to this </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">offset</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> to form the </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Interrupt number</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. Then the processor looks up a certain data structure called the </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Interrupt Descriptor Table (IDT)</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> to give the interrupt handler address corresponding to the interrupt number.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Code at this address is then run, which handles the event.</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> <br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Setting up the IDT</span></p>
<p style=" margin-top:17px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">struct</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> IDT_entry{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">unsigned</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">short</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#89bdff;">int</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> offset_lowerbits;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">unsigned</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">short</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#89bdff;">int</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> selector;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">unsigned</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">char</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> zero;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">unsigned</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">char</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> type_attr;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">unsigned</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">short</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#89bdff;">int</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> offset_higherbits;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">struct</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> IDT_entry IDT[IDT_SIZE];</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">void</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> idt_init(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">void</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">unsigned</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">long</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> keyboard_address;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">unsigned</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">long</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> idt_address;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">unsigned</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">long</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> idt_ptr[</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">2</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">];</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* populate IDT entry of keyboard's interrupt */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	keyboard_address = (</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">unsigned</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">long</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">)keyboard_handler; </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	IDT[</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x21</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">].offset_lowerbits = keyboard_address &amp; </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0xffff</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	IDT[</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x21</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">].selector = </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x08</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">; </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* KERNEL_CODE_SEGMENT_OFFSET */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	IDT[</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x21</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">].zero = </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	IDT[</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x21</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">].type_attr = </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x8e</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">; </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* INTERRUPT_GATE */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	IDT[</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x21</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">].offset_higherbits = (keyboard_address &amp; </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0xffff0000</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">) &gt;&gt; </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">16</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/*     Ports</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">	*	 PIC1	PIC2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">	*Command 0x20	0xA0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">	*Data	 0x21	0xA1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">	*/</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* ICW1 - begin initialization */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	write_port(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x20</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> , </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x11</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	write_port(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0xA0</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> , </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x11</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* ICW2 - remap offset address of IDT */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/*</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">	* In x86 protected mode, we have to remap the PICs beyond 0x20 because</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">	* Intel have designated the first 32 interrupts as &quot;reserved&quot; for cpu exceptions</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">	*/</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	write_port(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x21</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> , </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x20</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	write_port(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0xA1</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> , </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x28</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* ICW3 - setup cascading */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	write_port(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x21</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> , </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x00</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">);  </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	write_port(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0xA1</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> , </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x00</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">);  </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* ICW4 - environment info */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	write_port(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x21</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> , </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x01</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	write_port(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0xA1</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> , </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x01</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* Initialization finished */</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* mask interrupts */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	write_port(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x21</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> , </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0xff</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	write_port(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0xA1</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> , </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0xff</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* fill the IDT descriptor */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	idt_address = (</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">unsigned</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">long</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">)IDT ;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	idt_ptr[</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">] = (</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">sizeof</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> (</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">struct</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> IDT_entry) * IDT_SIZE) + ((idt_address &amp; </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0xffff</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">) &lt;&lt; </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">16</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	idt_ptr[</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">1</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">] = idt_address &gt;&gt; </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">16</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> ;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	load_idt(idt_ptr);</span></p>
<p style=" margin-top:0px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">}</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">We implement IDT as an array comprising structures</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">IDT_entry</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. We’ll discuss how the keyboard interrupt is mapped to its handler later in the article. First, let’s see how the PICs work.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Modern x86 systems have 2 PIC chips each having</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">8 input lines</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. Let’s call them PIC1 and PIC2. PIC1 receives IRQ0 to IRQ7 and PIC2 receives IRQ8 to IRQ15. PIC1 uses port </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x20</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> for Command and </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x21</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> for Data. PIC2 uses port </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0xA0</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> for Command and </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0xA1</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> for Data.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">The PICs are initialized using 8-bit command words known as</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Initialization command words (ICW)</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. See </span><a href="https://t.umblr.com/redirect?z=%2F%2Fstanislavs.org%2Fhelppc%2F8259.html&amp;t=ZmJjNWQ2YmY5MTVlMTJiMGYxNzQ0MTI4OTg1Njk0M2Y2NDgyZDc1Mix5aXJmUUdUOA%3D%3D&amp;b=t%3AlMu0rOs9jGwbQo_qiwGh_A&amp;p=https%3A%2F%2Farjunsreedharan.org%2Fpost%2F99370248137%2Fkernels-201-lets-write-a-kernel-with-keyboard&amp;m=1"><span style=" font-family:'arial,sans-serif'; font-size:9pt; text-decoration: underline; color:#0f6692;">this link</span></a><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> for the exact bit-by-bit syntax of these commands.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">In protected mode, the first command you will need to give the two PICs is the initialize command</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">ICW1</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> (</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x11</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">). This command makes the PIC wait for 3 more initialization words on the data port.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">These commands tell the PICs about:</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">* Its vector offset. (ICW2)</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br />* How the PICs wired as master/slaves. (ICW3)<br />* Gives additional information about the environment. (ICW4)</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">The second initialization command is the ICW2, written to the data ports of each PIC. It sets the PIC’s offset value. This is the value to which we add the input line number to form the Interrupt number.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">PICs allow cascading of their outputs to inputs between each other. This is setup using ICW3 and each bit represents cascading status for the corresponding IRQ. For now, we won’t use cascading and set all to zeroes.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">ICW4 sets the additional enviromental parameters. We will just set the lower most bit to tell the PICs we are running in the 80x86 mode.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Tang ta dang !! PICs are now initialized.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; font-family:'Sans Serif'; font-size:9pt; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Each PIC has an internal 8 bit register named</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Interrupt Mask Register (IMR)</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. This register stores a bitmap of the IRQ lines going into the PIC. When a bit is set, the PIC ignores the request. This means we can enable and disable the nth IRQ line by making the value of the nth bit in the IMR as 0 and 1 respectively. Reading from the data port returns value in the IMR register, and writing to it sets the register. Here in our code, after initializing the PICs; we set all bits to 1 thereby disabling all IRQ lines. We will later enable the line corresponding to keyboard interrupt. As of now, let’s disable all the interrupts !!</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Now if IRQ lines are enabled, our PICs can receive signals via IRQ lines and convert them to interrupt number by adding with the offset. Now, we need to populate the IDT such that the interrupt number for the keyboard is mapped to the address of the keyboard handler function we will write.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Which interrupt number should the keyboard handler address be mapped against in the IDT?</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">The keyboard uses IRQ</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">1</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. This is the input line 1 of PIC1. We have initialized PIC1 to an offset </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x20</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> (see ICW2). To find interrupt number, add </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">1</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">+</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x20</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> ie. </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x21</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. So, keyboard handler address has to be mapped against interrupt </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x21</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> in the IDT.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">So, the next task is to populate the IDT for the interrupt</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x21</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">.<br />We will map this interrupt to a function </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">keyboard_handler</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> which we will write in our assembly file.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Each IDT entry consist of 64 bits. In the IDT entry for the interrupt, we do not store the entire address of the handler function together. We split it into 2 parts of 16 bits. The lower bits are stored in the first 16 bits of the IDT entry and the higher 16 bits are stored in the last 16 bits of the IDT entry. This is done to maintain compatibility with the 286. You can see Intel pulls shrewd kludges like these in so many places !!</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">In the IDT entry, we also have to set the type - that this is done to trap an interrupt. We also need to give the kernel code segment offset. GRUB bootloader sets up a</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><a href="https://t.umblr.com/redirect?z=%2F%2Fen.wikipedia.org%2Fwiki%2FGlobal_Descriptor_Table&amp;t=NDQwZGQzMWEyNTg4NjBkODM0ZDExNDQ4NDAyZjZhNGZmNDIwZWQwMSx5aXJmUUdUOA%3D%3D&amp;b=t%3AlMu0rOs9jGwbQo_qiwGh_A&amp;p=https%3A%2F%2Farjunsreedharan.org%2Fpost%2F99370248137%2Fkernels-201-lets-write-a-kernel-with-keyboard&amp;m=1"><span style=" font-family:'arial,sans-serif'; font-size:9pt; text-decoration: underline; color:#0f6692;">GDT</span></a><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> for us. Each GDT entry is 8 bytes long, and the kernel code descriptor is the second segment; so its offset is </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x08</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> (More on this would be too much for this article). Interrupt gate is represented by </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x8e</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. The remaining 8 bits in the middle has to be filled with all zeroes. In this way, we have filled the IDT entry corresponding to the keyboard’s interrupt.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Once the required mappings are done in the IDT, we got to tell the CPU where the IDT is located.</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br />This is done via the </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">lidt</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> assembly instruction. </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">lidt</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> take one operand. The operand must be a pointer to a descriptor structure that describes the IDT.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">The descriptor is quite straight forward. It contains the size of IDT in bytes and its address. I have used an array to pack the values. You may also populate it using a struct.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">We have the pointer in the variable</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">idt_ptr</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> and then pass it on to </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">lidt</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> using the function </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">load_idt()</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">.</span></p>
<p style=" margin-top:17px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">load_idt:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	mov edx, [esp + </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">4</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	lidt [edx]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	sti</span></p>
<p style=" margin-top:0px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	ret</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Additionally,</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">load_idt()</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> function turns the interrupts on using </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">sti</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> instruction.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Once the IDT is set up and loaded, we can turn on keyboard’s IRQ line using the interrupt mask we discussed earlier.</span></p>
<p style=" margin-top:17px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">void</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> kb_init(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">void</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* 0xFD is 11111101 - enables only IRQ1 (keyboard)*/</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	write_port(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x21</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> , </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0xFD</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">);</span></p>
<p style=" margin-top:0px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; font-family:'Sans Serif'; font-size:9pt; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Keyboard interrupt handling function</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Well, now we have successfully mapped keyboard interrupts to the function</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">keyboard_handler</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> via IDT entry for interrupt </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x21</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">.<br />So, everytime you press a key on your keyboard you can be sure this function is called.</span></p>
<p style=" margin-top:17px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">keyboard_handler:                 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	call    keyboard_handler_main</span></p>
<p style=" margin-top:0px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	iretd</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">This function just calls another function written in C and returns using the</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">iret</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> class of instructions. We could have written our entire interrupt handling process here, however it’s much easier to write code in C than in assembly - so we take it there. <br /></span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">iret</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">/</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">iretd</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> should be used instead of </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">ret</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> when returning control from an interrupt handler to a program that was interrupted by an interrupt. These class of instructions pop the flags register that was pushed into the stack when the interrupt call was made.</span></p>
<p style=" margin-top:17px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">void</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> keyboard_handler_main(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">void</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">unsigned</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">char</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> status;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">char</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> keycode;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* write EOI */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	write_port(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x20</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">, </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x20</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	status = read_port(KEYBOARD_STATUS_PORT);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* Lowest bit of status will be set if buffer is not empty */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">if</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> (status &amp; </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x01</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		keycode = read_port(KEYBOARD_DATA_PORT);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">if</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">(keycode &lt; </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">			</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">return</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		vidptr[current_loc++] = keyboard_map[keycode];</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		vidptr[current_loc++] = </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x07</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;	</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	}</span></p>
<p style=" margin-top:0px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">}</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">We first signal</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">EOI</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> (End Of Interrput acknowlegment) by writing it to the PIC’s command port. Only after this; will the PIC allow further interrupt requests. We have to read 2 ports here - the data port </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x60</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> and the command/status port </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x64</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">We first read port</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x64</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> to get the status. If the lowest bit of the status is </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">, it means the buffer is empty and there is no data to read. In other cases, we can read the data port </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0x60</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. This port will give us a keycode of the key pressed. Each keycode corresponds to each key on the keyboard. We use a simple character array defined in the file </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">keyboard_map.h</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> to map the keycode to the corresponding character. This character is then printed on to the screen using the same technique we used in the previous article.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">In this article for the sake of brevity, I am only handling lowercase a-z and digits 0-9. You can with ease extend this to include special characters, ALT, SHIFT, CAPS LOCK. You can get to know if the key was pressed or released from the status port output and perform desired action. You can also map any combination of keys to special functions such as shutdown etc.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">You can build the kernel, run it on a real machine or an emulator (QEMU) exactly the same way as in the</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><a href="https://arjunsreedharan.org/post/82710718100/kernel-101-lets-write-a-kernel"><span style=" font-family:'arial,sans-serif'; font-size:9pt; text-decoration: underline; color:#0f6692;">earlier article</span></a><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> (</span><a href="https://github.com/arjun024/mkernel"><span style=" font-family:'arial,sans-serif'; font-size:9pt; text-decoration: underline; color:#0f6692;">its repo</span></a><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">).</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Start typing !!</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><img src="image1546685891svouqdxrcp.png" /><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">References and Thanks</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px;"><span style=" font-size:14px;">1. </span><a href="https://wiki.osdev.org/"><span style=" font-size:14px; text-decoration: underline; color:#0f6692;">wiki.osdev.org</span></a></li>
<li style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px;"><span style=" font-size:14px;">2. </span><a href="https://www.osdever.net/"><span style=" font-size:14px; text-decoration: underline; color:#0f6692;">osdever.net</span></a></li></ol>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"> </span></p></body></html>