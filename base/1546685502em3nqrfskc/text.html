<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p align="center" style=" margin-top:0px; margin-bottom:32px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#e3e3e3;"><a href="https://arjunsreedharan.org/post/82710718100/kernels-101-lets-write-a-kernel"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; text-decoration: underline; color:#222222;">Kernels 101 –<br />Let’s write a Kernel</span></a></p>
<p align="center" style=" margin-top:17px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://arjunsreedharan.org/"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:792; text-decoration: underline; color:#222222; background-color:#e3e3e3;">Arjun Sreedharan</span></a></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Hello World,</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Let us write a simple kernel which could be loaded with the GRUB bootloader on an x86 system. This kernel will display a message on the screen and then hang.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><img src="image1546685541h9ytqsy0ng.png" /></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">How does an x86 machine boot</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Before we think about writing a kernel, let’s see how the machine boots up and transfers control to the kernel:</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Most registers of the x86 CPU have well defined values after power-on. The Instruction Pointer (EIP) register holds the memory address for the instruction being executed by the processor. EIP is hardcoded to the value</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">0xFFFFFFF0</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. Thus, the x86 CPU is hardwired to begin execution at the physical address 0xFFFFFFF0. It is in fact, the last 16 bytes of the 32-bit address space. This memory address is called reset vector.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Now, the chipset’s memory map makes sure that 0xFFFFFFF0 is mapped to a certain part of the BIOS, not to the RAM. Meanwhile, the BIOS copies itself to the RAM for faster access. This is called</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">shadowing</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. The address 0xFFFFFFF0 will contain just a jump instruction to the address in memory where BIOS has copied itself.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Thus, the BIOS code starts its execution.  BIOS first searches for a bootable device in the configured boot device order. It checks for a certain magic number to determine if the device is bootable or not. (whether bytes 511 and 512 of first sector are</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">0xAA55</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">)</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Once the BIOS has found a bootable device, it copies the contents of the device’s first sector into RAM starting from physical address</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">0x7c00</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">; and then jumps into the address and executes the code just loaded. This code is called the </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">bootloader</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">The bootloader then loads the kernel at the physical address</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">0x100000</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. The address 0x100000 is used as the start-address for all big kernels on x86 machines.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">All x86 processors begin in a simplistic 16-bit mode called</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">real mode</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. The GRUB bootloader makes the switch to 32-bit </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">protected mode</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> by setting the lowest bit of </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">CR0</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> register to </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">1</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. Thus the kernel loads in 32-bit protected mode.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Do note that in case of linux kernel, GRUB detects linux boot protocol and loads linux kernel in real mode. Linux kernel itself</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><a href="https://github.com/torvalds/linux/blob/master/arch/x86/boot/main.c#L181"><span style=" font-family:'arial,sans-serif'; font-size:9pt; text-decoration: underline; color:#0f6692;">makes the switch</span></a><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> to protected mode.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">What all do we need?</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">* An x86 computer (of course)</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br />* Linux <br />* </span><a href="https://www.nasm.us/"><span style=" font-family:'arial,sans-serif'; font-size:9pt; text-decoration: underline; color:#0f6692;">NASM assembler</span></a><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br />* gcc<br />* ld (GNU Linker)<br />* grub</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Source Code</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Source code is available at my</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><a href="https://github.com/arjun024/mkernel"><span style=" font-family:'arial,sans-serif'; font-size:9pt; text-decoration: underline; color:#0f6692;">Github repository - mkernel</span></a></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">The entry point using assembly</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">We like to write everything in C, but we cannot avoid a little bit of assembly. We will write a small file in x86 assembly-language that serves as the starting point for our kernel. All our assembly file will do is invoke an external function which we will write in C, and then halt the program flow.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">How do we make sure that this assembly code will serve as the starting point of the kernel?</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">We will use a linker script that links the object files to produce the final kernel executable. (more explained later)  In this linker script, we will explicitly specify that we want our binary to be loaded at the address 0x100000. This address, as I have said earlier, is where the kernel is expected to be. Thus, the bootloader will take care of firing the kernel’s entry point.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Here’s the assembly code:</span></p>
<p style=" margin-top:17px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;;kernel.</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">asm</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">bits </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">32</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">			;nasm directive - </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">32</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> bit</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">section .text</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">global</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> start</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">extern</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> kmain	        ;kmain </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">is</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">defined</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">in</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> the c file</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">start:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">  cli 			;block interrupts</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">  mov esp, stack_space	;</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">set</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> stack pointer</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">  call kmain</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">  hlt		 	;halt the CPU</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">section .bss</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">resb </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">8192</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		;</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">8KB</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">for</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> stack</span></p>
<p style=" margin-top:0px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">stack_space:</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">The first instruction</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">bits 32</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> is not an x86 assembly instruction. It’s a directive to the NASM assembler that specifies it should generate code to run on a processor operating in 32 bit mode. It is not mandatorily required in our example, however is included here as it’s good practice to be explicit.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">The second line begins the text section (aka code section). This is where we put all our code.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">global</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> is another NASM directive to set symbols from source code as global. By doing so, the linker knows where the symbol </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">start</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> is; which happens to be our entry point.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">kmain</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> is our function that will be defined in our </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">kernel.c</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> file. </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">extern</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> declares that the function is declared elsewhere.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Then, we have the</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">start</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> function, which calls the </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">kmain</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> function and halts the CPU using the </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">hlt</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> instruction. Interrupts can awake the CPU from an </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">hlt</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> instruction. So we disable interrupts beforehand using </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">cli</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> instruction. </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">cli</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> is short for clear-interrupts.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">We should ideally set aside some memory for the stack and point the stack pointer (</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">esp</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">) to it. However, it seems like GRUB does this for us and the stack pointer is already set at this point. But, just to be sure, we will allocate some space in the BSS section and point the stack pointer to the beginning of the allocated memory. We use the </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">resb</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> instruction which reserves memory given in bytes. After it, a label is left which will point to the edge of the reserved piece of memory. Just before the </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">kmain</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> is called, the stack pointer (</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">esp</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">) is made to point to this space using the </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">mov</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> instruction.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">The kernel in C</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">In</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">kernel.asm</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">, we made a call to the function </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">kmain()</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. So our C code will start executing at </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">kmain()</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">:</span></p>
<p style=" margin-top:17px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/*</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">*  kernel.c</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">*/</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">void</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> kmain(</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">void</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">const</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">char</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> *str = </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#65b042;">&quot;my first kernel&quot;</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">char</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> *vidptr = (</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">char</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">*)</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0xb8000</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">; 	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">//video mem begins here.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">unsigned</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#89bdff;">int</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> i = </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">unsigned</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#89bdff;">int</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> j = </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* this loops clears the screen</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">	* there are 25 lines each of 80 columns; each element takes 2 bytes */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">while</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">(j &lt; </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">80</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> * </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">25</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> * </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">2</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* blank character */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		vidptr[j] = </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#65b042;">' '</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* attribute-byte - light grey on black screen */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		vidptr[j+</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">1</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">] = </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x07</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">; 		</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		j = j + </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">2</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	j = </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* this loop writes the string to video memory */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">while</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">(str[j] != </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#65b042;">'\0'</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* the character's ascii */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		vidptr[i] = str[j];</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/* attribute-byte: give character black bg and light grey fg */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		vidptr[i+</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">1</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">] = </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x07</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		++j;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		i = i + </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">2</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">return</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">}</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">All our kernel will do is clear the screen and write to it the string “my first kernel”.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">First we make a pointer</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">vidptr</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> that points to the address </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">0xb8000</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. This address is the start of video memory in protected mode. The screen’s text memory is simply a chunk of memory in our address space. The memory mapped input/output for the screen starts at 0xb8000 and supports 25 lines, each line contain 80 ascii characters.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Each character element in this text memory is represented by 16 bits (2 bytes), rather than 8 bits (1 byte) which we are used to.  The first byte should have the representation of the character as in ASCII. The second byte is the</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">attribute-byte</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. This describes the formatting of the character including attributes such as color.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">To print the character</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">s</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> in green color on black background, we will store the character </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">s</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> in the first byte of the video memory address and the value 0x02 in the second byte. <br /></span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">0</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> represents black background and </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">2</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> represents green foreground.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br />Have a look at table below for different colors:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#f5f5f5;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#333333; background-color:#f5f5f5;">0 - Black, 1 - Blue, 2 - Green, 3 - Cyan, 4 - Red, 5 - Magenta, 6 - Brown, 7 - Light Grey, 8 - Dark Grey, 9 - Light Blue, 10/a - Light Green, 11/b - Light Cyan, 12/c - Light Red, 13/d - Light Magenta, 14/e - Light Brown, 15/f – White.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">In our kernel, we will use light grey character on a black background. So our attribute-byte must have the value 0x07.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">In the first while loop, the program writes the blank character with 0x07 attribute all over the 80 columns of the 25 lines. This thus clears the screen.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">In the second while loop, characters of the null terminated string “my first kernel” are written to the chunk of video memory with each character holding an attribute-byte of 0x07.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">This should display the string on the screen.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">The linking part</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">We will assemble</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">kernel.asm</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> with NASM to an object file; and then using GCC we will compile </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">kernel.c</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> to another object file. Now, our job is to get these objects linked to an executable bootable kernel.<br /><br />For that, we use an explicit linker script, which can be passed as an argument to </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">ld</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> (our linker).</span></p>
<p style=" margin-top:17px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">/*</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">*  link.ld</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; font-style:italic; color:#aeaeae;">*/</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">OUTPUT_FORMAT(elf32-i386)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">ENTRY(start)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">SECTIONS</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">   . = </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x100000</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">   .text : { *(.text) }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">   .data : { *(.data) }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">   .bss  : { *(.bss)  }</span></p>
<p style=" margin-top:0px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> }</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">First, we set the</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">output format</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> of our output executable to be 32 bit </span><a href="https://elinux.org/Executable_and_Linkable_Format_(ELF)"><span style=" font-family:'arial,sans-serif'; font-size:9pt; text-decoration: underline; color:#0f6692;">Executable and Linkable Format</span></a><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> (ELF). ELF is the standard binary file format for Unix-like systems on x86 architecture.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">ENTRY</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> takes one argument. It specifies the symbol name that should be the entry point of our executable.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">SECTIONS</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> is the most important part for us. Here, we define the layout of our executable. We could specify how the different sections are to be merged and at what location each of these is to be placed.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Within the braces that follow the SECTIONS statement, the period character (.) represents the</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">location counter</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">.<br />The location counter is always initialized to 0x0 at beginning of the SECTIONS block. It can be modified by assigning a new value to it.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Remember, earlier I told you that kernel’s code should start at the address 0x100000. So, we set the location counter to 0x100000.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Have look at the next line</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">.text : { *(.text) }</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">The asterisk (*) is a wildcard character that matches any file name. The expression</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;"> *(.text)</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">thus means all </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">.text</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> input sections from all input files.<br /><br />So, the linker merges all text sections of the object files to the executable’s text section, at the address stored in the location counter. Thus, the code section of our executable begins at 0x100000.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">After the linker places the text output section, the value of the location counter will become</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> <br />0x1000000 + the size of the text output section.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Similarly, the data and bss sections are merged and placed at the then values of location-counter.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Grub and Multiboot</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Now, we have all our files ready to build the kernel. But, since we like to boot our kernel with the</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><a href="https://www.gnu.org/software/grub/"><span style=" font-family:'arial,sans-serif'; font-size:9pt; text-decoration: underline; color:#0f6692;">GRUB bootloader</span></a><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">, there is one step left.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">There is a standard for loading various x86 kernels using a boot loader; called as</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Multiboot specification</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">GRUB will only load our kernel if it complies with the</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><a href="https://www.gnu.org/software/grub/manual/multiboot/multiboot.html"><span style=" font-family:'arial,sans-serif'; font-size:9pt; text-decoration: underline; color:#0f6692;">Multiboot spec</span></a><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">According to the spec, the kernel must contain a header (known as Multiboot header) within its first 8 KiloBytes.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Further, This Multiboot header must contain 3 fields that are 4 byte aligned namely:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'arial,sans-serif'; font-size:9pt; color:#222222;" style=" margin-top:15px; margin-bottom:8px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px;"><span style=" font-size:14px;">a </span><span style=" font-size:14px; font-weight:600;">magic</span><span style=" font-size:14px;"> field: containing the magic number </span><span style=" font-size:14px; font-weight:600;">0x1BADB002</span><span style=" font-size:14px;">, to identify the header.</span></li>
<li style=" font-family:'arial,sans-serif'; font-size:9pt; color:#222222;" style=" margin-top:8px; margin-bottom:8px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px;"><span style=" font-size:14px;">a </span><span style=" font-size:14px; font-weight:600;">flags</span><span style=" font-size:14px;"> field: We will not care about this field. We will simply set it to zero.</span></li>
<li style=" font-family:'arial,sans-serif'; font-size:9pt; color:#222222;" style=" margin-top:8px; margin-bottom:15px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px;"><span style=" font-size:14px;">a </span><span style=" font-size:14px; font-weight:600;">checksum</span><span style=" font-size:14px;"> field: the checksum field when added to the fields ‘magic’ and ‘flags’ must give zero.</span></li></ul>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">So our</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">kernel.asm</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> will become:</span></p>
<p style=" margin-top:17px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;;kernel.</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">asm</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">;nasm directive - </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">32</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> bit</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">bits </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">32</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">section .text</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">        ;multiboot spec</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">        align </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">4</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">        dd </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x1BADB002</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">            ;magic</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">        dd </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x00</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">                  ;flags</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">        dd - (</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x1BADB002</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> + </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">0x00</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">) ;checksum. m+f+c should be zero</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">global</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> start</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">extern</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> kmain	        ;kmain </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">is</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">defined</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">in</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> the c file</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">start:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">  cli 			;block interrupts</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">  mov esp, stack_space	;</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">set</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> stack pointer</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">  call kmain</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">  hlt		 	;halt the CPU</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff; background-color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">section .bss</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">resb </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">8192</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">		;</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">8KB</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">for</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> stack</span></p>
<p style=" margin-top:0px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">stack_space:</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">The</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">dd</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> defines a double word of size 4 bytes. <br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Building the kernel</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">We will now create object files from</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">kernel.asm</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> and </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">kernel.c</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> and then link it using our linker script.</span></p>
<p style=" margin-top:17px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">nasm -f elf32 kernel.asm -o kasm.o</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">will run the assembler to create the object file kasm.o in ELF-32 bit format.</span></p>
<p style=" margin-top:17px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">gcc -m32 -c kernel.c -o kc.o</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">The ’-c ’ option makes sure that after compiling, linking doesn’t implicitly happen.</span></p>
<p style=" margin-top:17px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">ld -m elf_i386 -T link.ld -o kernel kasm.o kc.o</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">will run the linker with our linker script and generate the executable named</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">kernel</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">Configure your grub and run your kernel</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">GRUB requires your kernel to be of the name pattern</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">kernel-&lt;version&gt;</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;">. So, rename the kernel. I renamed my kernel executable to kernel-701.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Now place it in the</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">/boot</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> directory. You will require superuser privileges to do so.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">In your GRUB configuration file</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">grub.cfg</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> you should add an entry, something like:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#f5f5f5;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#333333; background-color:#f5f5f5;">title myKernel</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#f5f5f5;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#333333; background-color:#f5f5f5;">	root (hd0,0)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#f5f5f5;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#333333; background-color:#f5f5f5;">	kernel /boot/kernel-701 ro</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Don’t forget to remove the directive</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">hiddenmenu</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"> if it exists.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Reboot your computer, and you’ll get a list selection with the name of your kernel listed.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Select it and you should see:</span><img src="image15466855412xv8ksqkqh.png" /></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">That’s your kernel!!</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">PS:<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">* It’s always advisable to get yourself a virtual machine for all kinds of kernel hacking. * To run this on </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333; background-color:#ffffff;">grub2 </span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">which is the default bootloader for newer distros, your config should look like this:</span></p>
<p style=" margin-top:17px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">menuentry </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#65b042;">'kernel 701'</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#e28964;">set</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> root=</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#65b042;">'hd0,msdos1'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">	multiboot /boot/kernel-</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#3387cc;">701</span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;"> ro</span></p>
<p style=" margin-top:0px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">}</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">* Also, if you want to run the kernel on the </span><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#2211dd; background-color:#f7f7f9;">qemu</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;"> emulator instead of booting with GRUB, you can do so by:</span></p>
<p style=" margin-top:17px; margin-bottom:17px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; line-height:20px; background-color:#000000;"><span style=" font-family:'Monaco,Menlo,Consolas,Courier New,monospace'; font-size:9pt; color:#ffffff;">qemu-system-i386 -kernel kernel</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333; background-color:#ffffff;">Also, see the next article in the Kernel series:</span><span style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;"><br /></span><a href="http://arjunsreedharan.org/post/99370248137/kernels-201-lets-write-a-kernel-with-keyboard-and"><span style=" font-family:'arial,sans-serif'; font-size:9pt; text-decoration: underline; color:#0f6692;">Kernels 201 - Let’s write a Kernel with keyboard and screen support</span></a></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:140%; background-color:#ffffff;"><span style=" font-family:'arial,sans-serif'; font-size:9pt; font-weight:600; color:#333333;">References and Thanks</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px;"><span style=" font-size:14px;">1. </span><a href="https://wiki.osdev.org/"><span style=" font-size:14px; text-decoration: underline; color:#0f6692;">wiki.osdev.org</span></a></li>
<li style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px;"><span style=" font-size:14px;">2. </span><a href="https://www.osdever.net/"><span style=" font-size:14px; text-decoration: underline; color:#0f6692;">osdever.net</span></a></li>
<li style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px;"><span style=" font-size:14px;">3. </span><a href="http://www.gnu.org/software/grub/manual/multiboot/multiboot.html"><span style=" font-size:14px; text-decoration: underline; color:#0f6692;">Multiboot spec</span></a></li>
<li style=" font-family:'arial,sans-serif'; font-size:9pt; color:#333333;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px;"><span style=" font-size:14px;">4. Thanks to </span><a href="https://rubenlaguna.com/"><span style=" font-size:14px; text-decoration: underline; color:#0f6692;">Rubén Laguna</span></a><span style=" font-size:14px;"> from comments for grub2 config</span></li></ol>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif'; font-size:9pt;"> </span></p></body></html>